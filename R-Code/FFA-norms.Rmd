---
title: "FFA-Norm values"
subtitle: "Based on the 2009 Paper by Kohls, Sauer and Walach"
author: "Sebastian Sauer"
date: "`r Sys.time()`"
output:
  html_document:
    
    toc: yes
    number_sections: yes
    standalone: yes 
    code-fold: true
    df-print: kable
    #code_folding: hide
  pdf_document:
    toc: yes
    number_sections: yes
    extra_dependencies: ["float"]
  typst_document:
    toc: yes
    number_sections: yes
  word_document:
    toc: yes
editor_options:
  chunk_output_type: console
execute:
  cache: true
---





# Summary


- This analyses comprises (a) descriptive (summary) statistics as well as (b) norm values

- All analyses were based on the FMI13 as presented in Kohls, Sauer and Walach (2009): 

>   Kohls, N., Sauer, S., & Walach, H. (2009). Facets of mindfulness – Results of an online study investigating the Freiburg mindfulness inventory. *Personality and Individual Differences, 46*(2), 224–230. https://doi.org/10.1016/j.paid.2008.10.009
 

- Results are presented  for (a) a general factor solution (b) and for the two factor solution, based on the paper of Kohls, Sauer and Walach (2009)

- The present norm analyses includes the following norm values: z-values, T values, percentage rank empirical, percentage rank based on a normal distribution

- For the descriptive analyses, typical statistics are reproted, ie. mean, sd, range, quartiles, skewness, kurtosis as well as a "0-1-standardized mean", defined as mean/3 (as 3 is the theoretical upper limit of each score). This statistics is meant to easy comparison.

- A number of subgroup results are presented: by sex (female and male), continuous mindfulness training (yes or no), whether intensive mindfulnes retreats have been conducted (yes or noy), whether Vipassana training is practiced (yes or no), age (median split, ie., 49 years)




# Setup

Load R-Packages and other functions used.

```{r libs, message=FALSE}
library(easystats)
library(here)
library(tidyverse)
#library(knitr)
library(DataExplorer)
#library(scales)
library(knitr)
library(gt)
library(magrittr)  # extract2
library(lavaan)
library(semPlot)
library(psych)

```



```{r source-funs}
source("R-code/funs.R")
source("R-code/01-prepare-data.R")
```






```{r global-knitr-options, include=FALSE}
  knitr::opts_chunk$set(
  fig.pos = 'H',
  fig.asp = 0.618,
  fig.align='center',
  fig.width = 8,
  out.width = "100%",
  fig.cap = "", 
  fig.path = "chunk-img/",
  dpi = 300,
  # tidy = TRUE,
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  cache = TRUE)
```



```{r include=FALSE}
theme_set(theme_minimal())
```


# Data


## Prepare data

```{r prepare-data}
d_w_items <- prepare_FMI_data()
names(d_w_items)
```




## Item labels

```{r}
item_labels <- 
  read_csv("metadata/FMI-items.csv") |> 
  mutate(item_name = paste0("FFA_", nr))
```


## Matching items to factors

Presence items:

```{r}
item_labels |> 
  filter(facet_PAID_2009 == "Presence") |> 
  select(nr) |> 
  extract2(1)
```


Acceptance items:

```{r}
item_labels |> 
  filter(facet_PAID_2009 == "Acceptance") |> 
  select(nr)|> 
  extract2(1)
```


# Describe factors




## Visualization of factor distributions


```{r plot-distribs}
d_w_items %>% 
  select(ends_with("_mean")) %>% 
  plot_density() + theme_minimal()
```

Alternative visualization, 
keeping the x-axis constant:

```{r}
facet_labs <- c(acceptance13_mean = "Acceptance",
                fmi13_mean = "FMI-13R",
                fmi14_mean = "FMI-14",
                presence_mean = "Presence")
  

d_w_items %>% 
  select(ends_with("_mean")) %>% 
  pivot_longer(everything()) %>% 
  ggplot(aes(x = value)) +
  geom_density() +
  facet_wrap(~ name, labeller = as_labeller(facet_labs)) +
  theme_minimal() +
  theme(strip.text = element_text(size = 14),
                axis.text = element_text(size =14)) +
  labs(y = "",
       x = "mean score")

```





## Descriptive statistics

"Mean01" refers to a 0-1-standardized mean.

```{r describe-distribs, results="asis"}
d_w_items %>% 
  select(ends_with("_mean")) %>% 
  describe_distribution(iqr = FALSE, range = TRUE, quartiles = TRUE) %>% 
  mutate(Mean01 = Mean/3) %>% 
  mutate(Model = c("FMI-13R", "Presence", "Acceptance", "FMI-14")) |> 
  relocate(Mean01, .after = Mean) %>% 
  relocate(Model, .before = everything()) |> 
  select(-Variable, -n_Missing) |> 
  knitr::kable(digits = 2)
```





## Norms


```{r norms-overall, results = "asis"}
d_w_items %>% 
  select(ends_with("_mean")) %>% 
  map(~ knitr::kable(compute_all_norms(., min_score = 0, max_score = 3, by = .1), 
                     digits = 2))

```


```{r}
norms <-
d_w_items %>% 
  select(ends_with("_mean")) %>% 
  map(~ compute_all_norms(., 
                          min_score = 0, 
                          max_score = 3, 
                          by = .1), 
      digits = 2)


p_norm1 <- 
norms %>% 
  pluck(1) %>%
  ggplot(aes(x = score, y = z)) +
  geom_line() +
  scale_y_continuous(breaks = c(-2, 0, 2)) +
  theme(strip.text = element_text(size = 14),
                axis.text = element_text(size =14))


p_norm2 <-
norms %>% 
  pluck(1) %>%
  ggplot(aes(x = score, y = stanine)) +
  geom_line() + 
  scale_y_continuous(breaks = c(1, 5, 9)) +
  theme(strip.text = element_text(size = 14),
                axis.text = element_text(size =14))


p_norm3 <-
norms %>% 
  pluck(1) %>%
  ggplot(aes(x = score, y = perc_rank)) +
  geom_line() +
  labs(y = "Percentage")  +
  scale_y_continuous(breaks = c(0, .5, 1),
                     
                     labels = c("0%", "50%", "100%")) +
  theme(strip.text = element_text(size = 14),
                axis.text = element_text(size =14))


see::plots(p_norm1, p_norm2, p_norm3, tags = TRUE,
           n_rows = 3)
  
# 
# see::plots(p_norm1, p_norm2, p_norm3, tags = TRUE,
#            n_rows = 3,
#            title =  "FMI-13R mean value (x-axis) vs. different norm values (y-axis)")
```



# Item statistics and reliability


## FMI14

Item statistics:

```{r fmi14-stats}
fmi14_desc1 <- 
d_w_items |> 
  select(starts_with("ffa_", ignore.case = FALSE)) |> 
  psych::alpha()

col_names <- c("Nr.", "mean", "*SD*", "*r<sub>it</sub>*", "*r<sub>it</sub> dropped*")

fmi14_desc1[["item.stats"]] |> 
  mutate(nr = 1:14) |> 
  select(nr, mean, sd, r.cor, r.drop) |> 
    kable(col.names = col_names, escape = FALSE, digits = 2, row.names = FALSE)
```


Omega:

```{r}
fmi14_omega <- 
d_w_items |> 
  select(starts_with("ffa_", ignore.case = FALSE)) |> 
  psych::omega(nfactors = 1)

fmi14_omega
```


## FMI13-R

```{r fmi13r-stats}
fmi13_desc1 <- 
d_w_items |> 
  select(starts_with("ffa_", ignore.case = FALSE)) |> 
  select(-ffa_13r) |> 
  psych::alpha()

col_names <- c("Nr.", "mean", "*SD*", "*r<sub>it</sub>*", "*r<sub>it</sub> dropped*")

fmi13_desc1[["item.stats"]] |> 
  mutate(nr = 1:13) |> 
  select(nr, mean, sd, r.cor, r.drop) |> 
    kable(col.names = col_names, escape = FALSE, digits = 2, row.names = FALSE)
```


Omega:

```{r fmi13-omega}
fmi13_omega <- 
d_w_items |> 
  select(starts_with("ffa_", ignore.case = FALSE)) |> 
  select(-ffa_13r) |> 
  psych::omega(nfactors = 1)

fmi13_omega
```






# CFA




rename the items for the sake of brevity:
 
```{r}
fmi_items <- 
 d_w_items %>%
  select(starts_with("ffa"), mindfulness_experience) |> 
  rename_with(~ gsub("^ffa_(\\d+[a-zA-Z]?)$", "i\\1", .), 
              starts_with("ffa_"))
```





## Setup

```{r cfa-setup}
cfa_results <- list()

get_results_list <- function(cfa_model, model_name) {
  out <- list()
  
  out <- list(
    obj_name = deparse(substitute(cfa_model)),
    model_name = model_name,
   # overview = list(summary(cfa_model)),
    cfi = fitMeasures(cfa_model)["cfi"],
    tli = fitMeasures(cfa_model)["tli"],
    rmsea = fitMeasures(cfa_model)["rmsea"],
    srmr = fitMeasures(cfa_model)["srmr"]
  )
}
```



### Tetrachoric correlation matrix


```{r polychoric}
polychoric_r <- polychoric(fmi_items |> select(-mindfulness_experience))

polychoric_rho <- polychoric_r$rho

polychoric_rho[lower.tri(polychoric_r$rho, diag = FALSE)] <- NA

polychoric_rho |> kable( digits = 2)
```




## One general mindfulness factor, including item 13



```{r def-modle-one-dim}
FMI14 <- 
  "General_Factor=~i1+i2+i3+i4+i5+i6+i7+i8+i9+i10+i11+i12+i13r+i14"
```


### items as categorical, Pearson

```{r}
one_factor_ordered_pearson <- cfa(FMI14, 
                          data = fmi_items,
                          estimator = "DWLS",
                          ordered = TRUE)

cfa_results[["FMI-14, ordered, Pearson"]] <- 
  get_results_list(one_factor_ordered_pearson,
                   model_name = "FMI-14, ordered, Pearson")
  
```


### items as categorical, Polychoric

```{r}
one_factor_ordered_polychoric <- cfa(FMI14, 
                                      data = fmi_items,
                                      estimator = "DWLS",
                                      sample.cov = polychoric_rho,
                                      ordered = TRUE)

cfa_results[["FMI-14, ordered, polychoric"]] <- 
  get_results_list(one_factor_ordered_polychoric,
                   model_name = "FMI-14, ordered, polychoric")
  
```




### items as numerical

```{r}
one_factor_numeric <- cfa(FMI14, data = fmi_items)

  cfa_results[["FMI-14, numeric"]] <- 
  get_results_list(one_factor_numeric,
                   model_name = "FMI-14, numeric")
```


### items as categorical, Polychoric, mindfulness practitioners only

```{r}
one_factor_ordered_polychoric_practitioners <- cfa(FMI14, 
                                     data = fmi_items |> filter(mindfulness_experience == 1),
                                      estimator = "DWLS",
                                      sample.cov = polychoric_rho,
                                      ordered = TRUE)

cfa_results[["FMI-14, ordered, polychoric, mindfulness practitioners"]] <- 
  get_results_list(one_factor_ordered_polychoric_practitioners,
                   model_name = "FMI-14, ordered, polychoric, mindfulness practitioners")
  
```


## Two factors (presence, acceptance) without item 13, correlated factors

```{r}
FMI13R <- "
# Presence:
presence =~ i1 + i2 + i3 + i5 + i7 + i10 

acceptance =~ i4 + i6 + i8 + i9 + i11 + i12 + i14

presence ~~ acceptance
"
```







### items as numeric:

```{r}
two_factors_numeric <- cfa(FMI13R,
                           data = fmi_items)

cfa_results[["FMI-13R, numeric"]] <-
  get_results_list(two_factors_numeric,
                   model_name = "FMI-13R, numeric")
```


### items as categorical, Pearson

```{r}
model_two_dim_wo_13_ordered <- cfa(FMI13R,
                                   data = fmi_items,
                                   estimator = "DWLS",
                                   ordered = TRUE)


cfa_results[["FMI-13R, ordered, Pearson"]] <-
  get_results_list(model_two_dim_wo_13_ordered,
                   model_name = "FMI-13R, ordered, Pearson")
```

### items as categorical, Polychoric

```{r}
model_two_dim_wo_13_ordered_poly<- cfa(FMI13R,
                                   data = fmi_items,
                                   estimator = "DWLS",
                                   sample.cov = polychoric_rho,
                                   ordered = TRUE)


cfa_results[["FMI-13R, ordered, polychoric"]] <-
  get_results_list(model_two_dim_wo_13_ordered_poly,
                   "FMI-13R, ordered, polychoric")
```


### Plot


```{r semplot1}
semPaths(model_two_dim_wo_13_ordered_poly,
         what = "path",
         whatLabels = "stand",
         layout = "circle",
        # sizeMan = 3,
         #style = "lisrel",
         residuals = FALSE,
         #fixed = FALSE,
         intercepts = FALSE,
         normalize = FALSE,
         thresholds = F,
         width = 12,
         height = 6,
        # rotation = 2,
        # intAtSide = TRUE,
       #  nCharNodes = 0
)
title("Two factors, ordered, polychoric")
```

Standardized parameters are shown (loadings, correlations).



## Two correlated factors, individuals with meditation practice only

### items as numeric

```{r model_two_dim_wo_13_meditators_only}
model_two_dim_wo_13_meditators_only <- 
  cfa(FMI13R,
      data = fmi_items |> filter(mindfulness_experience == 1))


cfa_results[["FMI-13R, numeric, mindfulness practitioners"]] <-
  get_results_list(model_two_dim_wo_13_meditators_only,
                   model_name = "FMI-13R, numeric, mindfulness practitioners")
```






### items as categorical, Pearson

```{r model_two_dim_wo_13_meditators_only_categorical}
model_two_dim_wo_13_meditators_only_categorical <- 
  cfa(FMI13R,
      estimator = "DWLS",
      ordered = TRUE,
      data = fmi_items |> filter(mindfulness_experience == 1))

cfa_results[["FMI-13R, ordered, Pearson, mindfulness practitioners"]] <-
  get_results_list(model_two_dim_wo_13_meditators_only_categorical,
                   model_name = "FMI-13R, ordered, Pearson, mindfulness practitioners")
```




### items as categorical, polychoric

```{r model_two_dim_wo_13_meditators_only_categorical_polychoric}
model_two_dim_wo_13_meditators_only_categorical_poly <- 
  cfa(FMI13R,
      estimator = "DWLS",
      ordered = TRUE,
      data = fmi_items |> filter(mindfulness_experience == 1))

cfa_results[["FMI-13R, ordered, polychoric, mindfulness practitioners"]] <-
  get_results_list(model_two_dim_wo_13_meditators_only_categorical_poly,
                   model_name = "FMI-13R, ordered, polychoric, mindfulness practitioners")
```


## Results

```{r cfa-results}
cfa_results_df <-
  do.call(rbind, lapply(cfa_results, as.data.frame))

cfa_results_df |> 
  select(-obj_name) |> 
  mutate(Nr = 1:nrow(cfa_results_df)) |> 
  rename(Model = model_name,
         CFI = cfi,
         TLI = tli,
         RMSEA = rmsea,
         SRMR = srmr) |> 
  relocate(Nr, .before = everything()) |> 
  kable(digits = 2, row.names = FALSE)
```





















# Norm values for different subgroups


The following subgroup variables were considered:

```{r}
subgroup_vars <- c("Geschlecht", "Achts_regel", "Retreats", "Vip_regel", "age_below_md")
subgroup_vars
```



## Split by sex


### Stats

```{r}
d_w_items %>% 
  #filter(Geschlecht %in% c("männlich", "weiblich")) %>% 
  mutate(Geschlecht = as.character(Geschlecht)) %>% 
  describe_fmi_stats(
                     var = Geschlecht)
```


Plot:

```{r}
plot_fmi_descriptives(data = d_w_items,
                      var = Geschlecht) 
```


### Norms

```{r norms-sex, results = "asis"}
for (i in unique(d_w_items$Geschlecht)) { 
  cat("Group: ", i, "\n")
  d_w_items %>% 
    filter(Geschlecht == i) %>% 
    select(ends_with("_mean")) %>% 
    map(~ knitr::kable(compute_all_norms(., min_score = 0, max_score = 3, by = .1), 
                       digits = 2))  %>% print()
}
```




## Split by continuous mindfulness training

### Stats


```{r}
describe_fmi_stats(data = d_w_items,
                   var = Achts_regel)
```





```{r}
plot_fmi_descriptives(data = d_w_items,
                      var = Achts_regel)
```



### Norms

```{r norms-training, results = "asis"}
for (i in unique(d_w_items$Achts_regel)) { 
  cat("Group: ", i, "\n")
  d_w_items %>% 
    filter(Achts_regel == i) %>% 
    select(ends_with("_mean")) %>% 
    map(~ knitr::kable(compute_all_norms(., min_score = 0, max_score = 3, by = .1), 
                       digits = 2)) %>% print()
}
```






## Split by retreats


### Stats

```{r}
describe_fmi_stats(data = d_w_items,
                   var = Retreats)
```



```{r}
plot_fmi_descriptives(data = d_w_items,
                      var = Retreats)
```


### Norms


```{r norms-retreats, results = "asis"}
for (i in unique(d_w_items$Retreats)) { 
  cat("Group: ", i, "\n")
  d_w_items %>% 
    filter(Retreats == i) %>% 
    select(ends_with("_mean")) %>% 
    map(~ knitr::kable(compute_all_norms(., min_score = 0, max_score = 3, by = .1), 
                       digits = 2)) %>% 
    print()
}
```





## Split by Vipassana continuously

### Stats


```{r}
describe_fmi_stats(data = d_w_items,
                   var = Vip_regel)
```



```{r}
plot_fmi_descriptives(data = d_w_items,
                      var = Vip_regel)
```


### Norms

```{r norms-vip, results = "asis"}
for (i in unique(d_w_items$Vip_regel)) { 
  cat("Group: ", i, "\n")
  d_w_items %>% 
    filter(Vip_regel == i) %>% 
    select(ends_with("_mean")) %>% 
    map(~ knitr::kable(compute_all_norms(., min_score = 0, max_score = 3, by = .1), 
                       digits = 2)) %>% 
    print()
}
```






## Split by Age

### Stats

Median age in sample?

```{r}
d_w_items$Alter %>% median()

d_w_items <-
  d_w_items %>%
  mutate(age_below_md = if_else(Alter < median(Alter), "young", "old"))
```



```{r}
describe_fmi_stats(data = d_w_items,
                   var = age_below_md)
```






```{r}
plot_fmi_descriptives(data = d_w_items,
                      var = age_below_md)
```

### Norms

```{r norms-age, results = "asis"}

for (i in unique(d_w_items$age_below_md)) { 
  cat("Group: ", i, "\n")
  d_w_items %>% 
    filter(age_below_md == i) %>% 
    select(ends_with("_mean")) %>% 
    map(~ knitr::kable(compute_all_norms(., min_score = 0, max_score = 3, by = .1), 
                       digits = 2)) %>% 
    print()
}
```







# Overview on descriptive statistics per subgroup




```{r subgroup-desc-stats}
subgroup_stats <- list()

for (i in seq_along(subgroup_vars)){

subgroup_stats[[i]] <- 
  d_w_items %>% 
  select(ends_with("mean"),
         any_of(subgroup_vars)[i]) %>% 
  group_by(across(any_of(subgroup_vars[i]))) %>% 
    describe_distribution() %>% 
  select(Variable, Mean, SD, IQR, Min, Max, n, .group)

subgroup_stats[[i]][["subgroup_var"]] <- subgroup_vars[i]
}

subgroup_stats_df <- do.call(rbind, subgroup_stats)

subgroup_stats_df <-
  subgroup_stats_df %>% 
  mutate(group = str_remove(.group, "^.+=")) %>% 
  select(-.group)

display(subgroup_stats_df)
```



```{r}
subgroup_stats_long <- 
subgroup_stats_df %>% 
  select(Variable, Mean, SD, group, subgroup_var) %>% 
  mutate(Subscale = str_remove(Variable, "_mean")) %>% 
  pivot_longer(-c(Variable, group, Mean, Subscale, subgroup_var), 
               values_to = "SD")

display(subgroup_stats_long)

# subgroup_stats_long %>% 
#   ggplot(aes(x = Variable, color = group)) +
#   geom_errorbar(aes(ymin = Mean-SD, ymax = Mean+SD), position = "dodge") +
#   geom_point2(aes(y = Mean), alpha = .7, size = 2) +
#   facet_wrap(subgroup_vars ~ Variable, scales = "free")
```


## Regression models



### m1

```{r m1}
#| eval: false
m1 <- lm(phq_sum ~ presence_mean + acceptance13_mean, data = d_w_items)
parameters(m1) %>% display()

performance(m1) %>% display
summary(m1)
```

Standardized data:

```{r m1-params}
#| eval: false
parameters(m1, standardize = "refit") %>% display
```




# Session info

```{r}
sessionInfo()
```

